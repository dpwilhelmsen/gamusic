<html>

<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="css/gamusic.css" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script>
        var playlist = [];
        var youtubeInfo = {};
        var socket = io.connect('http://localhost:3030');
        var storeInfo = function (info) {
    			youtubeInfo.title = info.data.title;
    			socket.emit('new_request', {
                    	request: youtubeInfo
                });
    			
		};
        $(document).ready(function () {
            // Connect to our node/websockets server
			
			var loadInfo = function (videoId) {
				var gdata = document.createElement("script");
				gdata.src = "http://gdata.youtube.com/feeds/api/videos/" + videoId + "?v=2&alt=jsonc&callback=storeInfo";
				var body = document.getElementsByTagName("body")[0];
				body.appendChild(gdata);
			};
			
			function parseVideoId(url){
				var prefix = '(v=|/v/|youtu.be/)';
				return url
					.match(new RegExp(prefix+'.*'))[0]
					.replace(new RegExp(prefix),'')
					.substr(0,11);
			}

            function displayPlaylist(data) {
            	if(data.hasOwnProperty('current')) {
                	var previous = data.playlist[data.current - 1];
                	var current = data.playlist[data.current];
                	var next = data.playlist[data.current + 1];
                	if (data.current > 0)
	            	   	$('#previous span').html(previous.title);
                	$('#current span').html(current.title);
                	$('#next span').html(next.title);
                }
            }

            function createAutoClosingAlert(selector, delay) {
                var alert = $(selector).alert();
                window.setTimeout(function() { alert.alert('close') }, delay);
            }

            function requestSuccessAlert() {
                $('.alerts-container').append('<div class="alert alert-success fade in">Your request has been successfully added to the playlist.</div>');
                createAutoClosingAlert('.alert', 2000);
                $(document).off('requestSuccessful');
            }

            // Initial set of notes, loop through and add to list
            socket.on('initial_setup', function (data) {
                displayPlaylist(data);
            });

            // New socket connected, display new count on page
            socket.on('users_connected', function (data) {
                $('#usersConnected').html('<span class="glyphicon glyphicon-user"></span>'+(data - 3));
            })

            // Add requested song to playlist
            socket.on('request_added', function(data){
                displayPlaylist(data);
                $(document).trigger('requestSuccessful');
            });

            socket.on('update_playlist', function (data) {
                displayPlaylist(data);
            });
            
            socket.on('request_complete', function (data) {
                displayPlaylist(data);
            });

            $('#makeRequest').click(function (e) {
            	e.preventDefault();
                var request = {};
                request.title = $('#title').val();
                request.url = $('#url').val();
                if (request.url.length <= 0) {
                    return;
                }
                var youtubeMatches = request.url.match(/(youtube.com|youtu.be)/);
                if(youtubeMatches && request.title.length == 0) {
                		loadInfo(parseVideoId(request.url));
                		youtubeInfo.url = request.url;
                }else{
                	socket.emit('new_request', {
                    	request: request
                	});
                }
                $('#title, #url').val('');
                $(document).on('requestSuccessful', requestSuccessAlert);
            });
        })
    </script>
</head>

<body>
    <div class="container play-status">

        <!-- Three columns of text below the carousel -->
        <div class="row">
            <div class="col-lg-3 left">
                <div id="previous">
                    <h3>Previous Track: </h3><span></span>
                </div>
            </div>
            <!-- /.col-lg-4 -->
            <div class="col-lg-6 middle">
                <div id="current">
                    <h2>Current Track:</h2>  <span></span>
                </div>
            </div>
            <!-- /.col-lg-4 -->
            <div class="col-lg-3 right">
                <div id="next">
                    <h3>Next Track: </h3><div class="small">May change based on requests.</div><span></span>
                </div>
            </div>
            <!-- /.col-lg-4 -->
        </div>
        <!-- /.row -->

        <div class="row">
            <div class="col-lg-8 request-form">
                <form class="form-inline">
                    <fieldset>

                        <!-- Form Name -->
                        <legend>Make a Request</legend>
                        <div class="alerts-container"></div>
                        <p class="help-block">Accepts Youtube, Soundcloud and MP3 links.</p>
                        <!-- Text input-->
                        <div class="form-group">
                            <label class="sr-only" for="title">Title (Optional)</label>
                            <input id="title" name="title" type="text" placeholder="Title (Optional for Youtube)" size="22" class="form-control input-lg">
                            <label class="sr-only url-label" for="url">Url</label>
                            <input id="url" name="url" type="text" placeholder="URL" class="form-control input-lg" required="">
                            <button id="makeRequest" name="makeRequest" class="btn btn-lg btn-default">Submit</button>
                        </div>

                    </fieldset>
                </form>
            </div>
            <div class="col-lg-4">
            	<div id="usersConnected"><span class="glyphicon glyphicon-user"></span></div>
            </div>
        </div>
    </div>
    <script src="js/bootstrap.min.js"></script>
</body>

</html>